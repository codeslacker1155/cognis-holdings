import { outputFile, pathExists } from "fs-extra";
import worker from "metro-transform-worker";
import { join, posix, sep } from "node:path";
import { createExtractor, extractToClassNames } from "@tamagui/static";
const extractor = createExtractor();
async function transform(config, projectRoot, filename, data, options) {
  const ogPath = config.ogTransformPath || config.transformerPath,
    transformer = ogPath ? require(ogPath).transform : worker.transform;
  if (config.tamagui.disable || options.platform !== "web" || options.type === "asset" || filename.includes("node_modules")) return transformer(config, projectRoot, filename, data, options);
  if (
  // could by a styled() call:
  filename.endsWith(".ts") || filename.endsWith(".tsx") || filename.endsWith(".jsx")) {
    const sourcePath = toPosixPath(join(projectRoot, filename)),
      source = `${data}`,
      out = await extractToClassNames({
        extractor,
        options: {
          // @ts-ignore
          platform: "web",
          ...config.tamagui
        },
        shouldPrintDebug: source.startsWith("// debug-verbose") ? "verbose" : source.startsWith("// debug"),
        source,
        sourcePath
      });
    if (out?.styles) {
      const tmpDir = join(projectRoot, ".tamagui", "css"),
        outStylePath = toPosixPath(join(tmpDir, `${filename}`.replace(/[^a-zA-Z0-9]/gi, "") + ".css"));
      process.env.DEBUG?.includes("tamagui") && console.info(" Outputting CSS file:", outStylePath);
      const existsAlready = await pathExists(outStylePath);
      return await outputFile(outStylePath, out.styles, "utf-8"), existsAlready || (await new Promise(res => setTimeout(res, 400))), transformer(config, projectRoot, filename, Buffer.from(`${out.js}
require("${outStylePath}")`, "utf-8"), options);
    }
  }
  return transformer(config, projectRoot, filename, data, options);
}
function toPosixPath(path) {
  return path.split(sep).join(posix.sep);
}
export { transform };
//# sourceMappingURL=transformer.mjs.map
